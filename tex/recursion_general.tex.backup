\section{Recursion formula in the general case}
We now move on to the general case. Let $X$ be an arbitrary toric variety (smooth and proper) and $Y \subseteq X$ a very ample hypersurface (not necessarily toric). The complete linear system associated to $\OO_X(Y)$ defines an embedding $i : X \hookrightarrow \PP^N$ such that $i^{-1}(H) = Y$ (for a certain hyperplane $H$). By the functoriality property of quasimap spaces (see Appendix \ref{Functoriality of Quasimap Spaces Section}) we have a map:
\begin{equation*} k := \mathcal Q(i) : \Q{0}{n}{X}{\beta} \to \Q{0}{n}{\PP^N}{d} \end{equation*}
where $d=i_*\beta$. Since $i$ is a closed embedding it follows that $k$ is as well. Furthermore $k$ admits a compatible perfect obstruction theory - see Section \ref{section:rel_pot_for_qm_functoriality} -, so we have a notion of virtual pull-back along $k$ (which coincides with the \emph{diagonal} pull-back according to Lemma \ref{lem:diagonal_virtual_coincide}).

It is easy to show that $k$ restricts to a morphism between the relative spaces, and thus we have a diagram of embeddings
\bcd
\Q{0}{\alpha}{X|Y}{\beta} \ar[d, "f", hook] \ar[r, "g", hook] \ar[dr, phantom, "\square"] & \Q{0}{\alpha}{\PP^N|H}{d} \ar[d, "j", hook] \\
\Q{0}{n}{X}{\beta}  \ar[r, "k", hook] & \Q{0}{n}{\PP^N}{d}
\ecd
which one can show is cartesian. As such we can define a virtual class on $\Q{0}{\alpha}{X|Y}{\beta}$ by (virtual or diagonal) pullback.

The idea is to prove the recursion formula for $(X,Y)$ by pulling back the formula for $(\PP^N,H)$ along $k = \mathcal Q(i)$. In order to do this, we need to understand how the various virtual classes involved in the formula pull back along this map. Note that the first two terms of the recursion formula pull back trivially along $k$, i.e. $\virt{\Q{0}{\alpha}{X|Y}{\beta}}=k^!\virt{\Q{0}{\alpha}{\PP^N|H}{d}}$ by the very definition. It remains to consider the third term, namely the virtual class of the comb locus. This is the technical heart of the proof.

\subsection{Comb loci pull back}
Recall that we can write $\mathcal D^\mathcal{Q}_{\alpha,k}(X|Y,\beta)$ as the disjoint union of spaces
\begin{equation*} \mathcal D^{\mathcal{Q}}(X|Y,A,B,M) = \Q{0}{A_0 \cup \{q_1, \ldots, q_r\}}{Y}{\beta_0} \times_{Y^r} \prod_{i=1}^r \Q{0}{\alpha^{(i)}\cup (m_i)}{X|Y}{\beta_i} \end{equation*}
where $A$ and $B$ are partitions of the marked points and curve class respectively, and $M=(m_1,\ldots,m_r)$ records the intersection multiplicity with $Y$ at the nodes which connect the internal component to the external components (the spine of the comb to the teeth). It is convenient to deal with each $\mathcal D^{\mathcal{Q}}(X|Y,A,B,M)$ separately.

The comb locus sits inside the full product
\begin{equation*} \mathcal E^{\mathcal{Q}}(X|Y,A,B,M) = \Q{0}{A_0 \cup \{q_1, \ldots, q_r\}}{Y}{\beta_0} \times \prod_{i=1}^r \Q{0}{\alpha^{(i)}\cup (m_i)}{X|Y}{\beta_i} \end{equation*}
which we may endow with the product virtual class
\begin{equation*} \virt{\mathcal E^{\mathcal{Q}}(X|Y,A,B,M)} = \virt{\Q{0}{A_0 \cup \{q_1, \ldots, q_r\}}{Y}{\beta_0}} \times \prod_{i=1}^r \virt{\Q{0}{\alpha^{(i)}\cup (m_i)}{X|Y}{\beta_i}} \end{equation*}
and the cartesian diagram
\bcd
\mathcal D^{\mathcal{Q}}(X|Y,A,B,M)\ar[r]\ar[d]\ar[dr,phantom,"\Box"] & \mathcal E^{\mathcal{Q}}(X|Y,A,B,M)\ar[d] \\
X^r\ar[r,"\Delta_{X^r}"] & X^r\times X^r
\ecd
let us define the following \emph{product} virtual class
\[
 \vip{\mathcal D^{\mathcal{Q}}(X|Y,A,B,M)}=\Delta_{X^r}^!\virt{\mathcal E^{\mathcal{Q}}(X|Y,A,B,M)}.
\]
The same we can do at the level of $\PP^N$ relative to $H$.

On the other hand, there is another cartesian diagram
\bcd
\mathcal D^\mathcal{Q}(X|Y,A,B,M) \ar[r,"k_{|D}"] \ar[d] \ar[rd,phantom,"\square"] & \mathcal D^\mathcal{Q}(\PP^N|H,A,i_* B,M) \ar[d] \\
\Q{0}{n}{X}{\beta} \ar[r,"k"] & \Q{0}{n}{\PP^N}{d}
\ecd
We wish to prove the following
\begin{lem} \label{Comb loci pull back} For any $\alpha$ we have:
\begin{equation*} k^! \vip{\mathcal D^\mathcal{Q}(\PP^N|H,A,i_*B,M)} = \vip{\mathcal D^\mathcal{Q}(X|Y,A,B,M)}. \end{equation*} \end{lem}

Introduce the following shorthand notation: assuming the data of $A$ (with $n=\lvert A\rvert$), $B$ (with $\beta=\sum_{\beta_i\in B} \beta_i$) and $M$ have been fixed for $X|Y$ (respectively, $A$, $i_*B$ and $M$ for $\PP^N|H$), set:
\begin{align*}
\mathcal{D}(X|Y) & := \mathcal D^{\mathcal{Q}}(X|Y,A,B,M) & \text{and similarly for the absolute space} \\
\mathcal{E}(X|Y) & := \mathcal E^{\mathcal{Q}}(X|Y,A,B,M) & \text{and similarly for the absolute space} \\
\mathcal{Q}(X) & :=\Q{0}{n}{X}{\beta}
\end{align*}
and similarly for $\PP^N|H$.

Consider the cartesian diagram
\bcd
\mathcal{E}(X|Y) \ar[d]\ar[r]\ar[dr,phantom,"\Box"] & \mathcal{E}(\PP^N|H)\ar[d,"\theta"] \\
\mathcal{E}(X)\ar[r] & \mathcal{E}(\PP^N)
\ecd
\begin{lemma}
 $\vip{\mathcal{E}(X|Y)}=\theta^!\vip{\mathcal{E}(X)}$, where $\theta^!$ is the diagonal pullback introduced in appendix XXX.
\end{lemma}
\begin{proof}
 The only thing to check is that
 \[
 \Q{0}{A_0\cup\{q_1\ldots,q_r\}}{Y}{\beta_0} \equiv \Q{0}{A_0\cup\{q_1\ldots,q_r\}}{X}{\beta_0}\times_{\Q{0}{A_0\cup\{q_1\ldots,q_r\}}{\PP^N}{d_0}} \Q{0}{A_0\cup\{q_1\ldots,q_r\}}{H}{d_0}
 \]
 This is done in appendix XXX.
\end{proof}

Consider the cartesian diagram
\bcd
\mathcal D(X)\ar[r]\ar[d,"\varphi_X"]\ar[dr,phantom,"\Box"] & \mathcal D(\PP^N)\ar[r]\ar[d,"\varphi_{\PP^N}"]\ar[dr,phantom,"\Box"] & \MM_{A,B}^{\operatorname{wt}}\ar[d,"\psi"] \\
\mathcal Q(X)\ar[r,"k"] & \mathcal Q(\PP^N)\ar[r] & \MM_{0,n}^{\operatorname{wt}}
\ecd
from which we see that
\[
 \psi^!\virt{\mathcal Q(X)}=k^!\psi^![\mathcal Q(\PP^N)]
\]
by commutativity of virtual pullbacks.

Finally, the relevant cartesian diagram is
\bcd
\mathcal D(X|Y)\ar[d]\ar[r]\ar[dr,phantom,"\Box"] & \mathcal E(X|Y)\ar[d]\ar[r]\ar[dr,phantom,"\Box"] & \mathcal E(\PP^N|H)\ar[d,"\theta"] \\
\mathcal D(X)\ar[d]\ar[r]\ar[dr,phantom,"\Box"] & \mathcal E(X)\ar[d]\ar[r] & \mathcal E(\PP^N) \\
X^r\ar[r,"\Delta_{X^r}"] & X^r\times X^r & {}
\ecd

The proof of lemma XXX follows now from
\begin{align*} \vip{\mathcal D(X|Y)} & = \Delta_{X^r}^! \virt{\mathcal E(X|Y)} & \\
& =  \Delta_{X^r}^! \theta^!\virt{\mathcal E(X)} & \text{by lemma XXX} \\
& =  \theta^!\Delta_{X^r}^! \virt{\mathcal E(X)} & \text{by commutativity} \\
& =  \theta^!\psi^!\virt{\mathcal Q(X)} & \text{by the splitting principle} \\
& =  \theta^!k^!\psi^![\mathcal Q(\PP^N)] & \text{by the above} \\
& =  \theta^!k^!\Delta_{(\PP^N)^r}^!\virt{\mathcal E(\PP^N)} & \text{by the splitting principle} \\
& =  k^!\Delta_{(\PP^N)^r}^!\theta^!\virt{\mathcal E(\PP^N)} & \text{by commutativity} \\
& =  k^!\vip{\mathcal D(\PP^N|H)}.
\end{align*}
